on: [push, pull_request]

defaults:
  run:
    shell: bash

jobs:
  rclex_test:
    runs-on: ubuntu-latest
    container: rclex/rclex_docker:latest

    steps:
        - name: clone rclex
          uses: actions/checkout@v2
          with: 
            repository: rclex/rclex
            path: rclex
        - name: clone rclex_connection_tests
          uses: actions/checkout@v2
          with:
            repository: rclex/rclex_connection_tests
            path: rclex_connection_tests

        - name: mix compile
          run: |
            source /opt/ros/dashing/setup.bash
            cd rclex
            mix local.hex --force
            mix deps.get
            mix compile

        - name: mix test
          run: |
            source /opt/ros/dashing/setup.bash
            cd rclex
            mix test

        - name: connection tests
          run: | 
            source /opt/ros/dashing/setup.bash
            cd rclex_connection_tests
            ./run-all.sh

